syms S x1 x2 x3 x4 x5 g c1 c2 cc A cd  x1r x2r x3r x3dot real

% k = sqrt(2*g/abs(x(1)-x(3)))*(x(1)-x(3));
% Q13 = S*c1*(exp(x4*cc))/(exp(x4*cc)+1)*sqrt(2*g*(x1-x3));
% Q23 = S*c2*(exp(x5*cc))/(exp(x5*cc)+1)*sqrt(2*g*(x2-x3));
Q13 = S*c1*(exp(x4*cc))/(exp(x4*cc)+1)*sqrt(2*g/abs(x1-x3))*(x1-x3);
Q23 = S*c2*(exp(x5*cc))/(exp(x5*cc)+1)*sqrt(2*g/abs(x2-x3))*(x2-x3);

f = 1/A*[-Q13 -Q23 Q13+Q23 -cd*x4 -cd*x5]';
Lfh3 = [0 0 1 0 0]*f;
dLfh3dx = [diff(Lfh3,x1) diff(Lfh3,x2) diff(Lfh3,x3) diff(Lfh3,x4) diff(Lfh3,x5)];
Lf2h3 = dLfh3dx*f;
% disp(simplify(Lf2h3));

alpha = [-1/A*Q13; -1/A*Q23; Lf2h3];

g1 = [1/A; 0 ;0;0;0];
g2 = [0;1/A;0;0;0];
g3 = [0;0;0;100/9;0];
g4 = [0;0;0;0;100/9];
Lg1Lfh3 = dLfh3dx*g1;
Lg2Lfh3 = dLfh3dx*g2;
Lg3Lfh3 = dLfh3dx*g3;
Lg4Lfh3 = dLfh3dx*g4;
beta = [1/A 0 0 0;
        0 1/A 0 0;
        Lg1Lfh3 Lg2Lfh3 Lg3Lfh3 Lg4Lfh3];
    
betaP = pinv(beta);

v = [-(x1-x1r); -(x2-x2r); -(x2-x3r)-2*(x3dot)];

u = simplify(betaP*(v-alpha));

%% 

% xr = [0.2 0.3 0.25];
% x3dot = 0.5;
% % xr = [ref(1) ref(2) ref(3)];
% A = 0.0154; S = 5e-5; g = 9.81;
% x1 = 0.1; x2 = 0.15; x3 = 0.12; x4 = 50; x5 = 70; g = 9.81; 
% c1 = 16.1462; c2 = 15.5166; cc = 12/100; cd = 100/99;
% x1r = 0.4; x2r = 0.3; x3r = 0.2;
% syms S x1 x2 x3 x4 x5 g c1 c2 cc A cd  x1r x2r x3r x3dot real
u = subs(u,[S x1 x2 x3 x4 x5 g c1 c2 cc A cd x1r x2r x3r x3dot],[5e-5 0.1 0.2 0.15 90 70 9.81 16 15 12/100 0.0154 100/99 0.4 0.3 0.35 0.5]);


% u1 = ((324*c1^2*g^2*exp(cc*(2*x4 + 3*x5)) + 972*c1^2*g^2*exp(cc*(3*x4 + 2*x5)) + 162*c1^2*g^2*exp(cc*(3*x4 + 4*x5)) + 324*c1^2*g^2*exp(cc*(4*x4 + 3*x5)) + 486*c1^2*g^2*exp(2*cc*(x4 + x5)) + 648*c1^2*g^2*exp(3*cc*(x4 + x5)) + 81*c1^2*g^2*exp(4*cc*(x4 + x5)) + 81*c1^2*g^2*exp(2*cc*x4) + 162*c1^2*g^2*exp(3*cc*x4) + 81*c1^2*g^2*exp(4*cc*x4) + 324*c1^2*g^2*exp(cc*(2*x4 + x5)) + 648*c1^2*g^2*exp(cc*(3*x4 + x5)) + 324*c1^2*g^2*exp(cc*(4*x4 + x5)) + 81*c1^2*g^2*exp(2*cc*(x4 + 2*x5)) + 486*c1^2*g^2*exp(2*cc*(2*x4 + x5)) + 160000*A^2*c2^2*cc^2*exp(cc*(x4 + 2*x5))*abs(g*(x1 - x3))*abs(g*(x2 - x3)) + 40000*A^2*c2^2*cc^2*exp(2*cc*(2*x4 + x5))*abs(g*(x1 - x3))*abs(g*(x2 - x3)) + 160000*A^2*c1^2*cc^2*g^2*exp(cc*(2*x4 + x5))*(x1 - x3)^2 + 40000*A^2*c1^2*cc^2*g^2*exp(2*cc*(x4 + 2*x5))*(x1 - x3)^2 + 160000*A^2*c2^2*cc^2*exp(cc*(3*x4 + 2*x5))*abs(g*(x1 - x3))*abs(g*(x2 - x3)) + 160000*A^2*c1^2*cc^2*g^2*exp(cc*(2*x4 + 3*x5))*(x1 - x3)^2 + 240000*A^2*c2^2*cc^2*exp(2*cc*(x4 + x5))*abs(g*(x1 - x3))*abs(g*(x2 - x3)) + 240000*A^2*c1^2*cc^2*g^2*exp(2*cc*(x4 + x5))*(x1 - x3)^2 + 40000*A^2*c2^2*cc^2*exp(2*cc*x5)*abs(g*(x1 - x3))*abs(g*(x2 - x3)) + 40000*A^2*c1^2*cc^2*g^2*exp(2*cc*x4)*(x1 - x3)^2)/(40000*A*cc^2*abs(g*(x1 - x3))*(4*c1^2*exp(cc*(2*x4 + 3*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(3*x4 + 2*x5))*abs(g*(x2 - x3)) + 6*c1^2*exp(2*cc*(x4 + x5))*abs(g*(x1 - x3)) + 6*c2^2*exp(2*cc*(x4 + x5))*abs(g*(x2 - x3)) + c1^2*exp(2*cc*x4)*abs(g*(x1 - x3)) + c2^2*exp(2*cc*x5)*abs(g*(x2 - x3)) + 4*c1^2*exp(cc*(2*x4 + x5))*abs(g*(x1 - x3)) + c1^2*exp(2*cc*(x4 + 2*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(x4 + 2*x5))*abs(g*(x2 - x3)) + c2^2*exp(2*cc*(2*x4 + x5))*abs(g*(x2 - x3)))) - (81*c1^2*g^2*exp(2*cc*x4)*(exp(cc*x4) + 1)^2*(exp(cc*x5) + 1)^4)/(40000*A*cc^2*abs(g*(x1 - x3))*(4*c1^2*exp(cc*(2*x4 + 3*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(3*x4 + 2*x5))*abs(g*(x2 - x3)) + 6*c1^2*exp(2*cc*(x4 + x5))*abs(g*(x1 - x3)) + 6*c2^2*exp(2*cc*(x4 + x5))*abs(g*(x2 - x3)) + c1^2*exp(2*cc*x4)*abs(g*(x1 - x3)) + c2^2*exp(2*cc*x5)*abs(g*(x2 - x3)) + 4*c1^2*exp(cc*(2*x4 + x5))*abs(g*(x1 - x3)) + c1^2*exp(2*cc*(x4 + 2*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(x4 + 2*x5))*abs(g*(x2 - x3)) + c2^2*exp(2*cc*(2*x4 + x5))*abs(g*(x2 - x3)))))*(x1r - x1 + (2^(1/2)*S*c1*exp(cc*x4)*(g*(x1 - x3))^(1/2))/(A*(exp(cc*x4) + 1)));
% u2 = ((972*c2^2*g^2*exp(cc*(2*x4 + 3*x5)) + 324*c2^2*g^2*exp(cc*(3*x4 + 2*x5)) + 324*c2^2*g^2*exp(cc*(3*x4 + 4*x5)) + 162*c2^2*g^2*exp(cc*(4*x4 + 3*x5)) + 486*c2^2*g^2*exp(2*cc*(x4 + x5)) + 648*c2^2*g^2*exp(3*cc*(x4 + x5)) + 81*c2^2*g^2*exp(4*cc*(x4 + x5)) + 81*c2^2*g^2*exp(2*cc*x5) + 162*c2^2*g^2*exp(3*cc*x5) + 81*c2^2*g^2*exp(4*cc*x5) + 324*c2^2*g^2*exp(cc*(x4 + 2*x5)) + 648*c2^2*g^2*exp(cc*(x4 + 3*x5)) + 324*c2^2*g^2*exp(cc*(x4 + 4*x5)) + 486*c2^2*g^2*exp(2*cc*(x4 + 2*x5)) + 81*c2^2*g^2*exp(2*cc*(2*x4 + x5)) + 160000*A^2*c1^2*cc^2*exp(cc*(2*x4 + x5))*abs(g*(x1 - x3))*abs(g*(x2 - x3)) + 40000*A^2*c1^2*cc^2*exp(2*cc*(x4 + 2*x5))*abs(g*(x1 - x3))*abs(g*(x2 - x3)) + 160000*A^2*c2^2*cc^2*g^2*exp(cc*(x4 + 2*x5))*(x2 - x3)^2 + 40000*A^2*c2^2*cc^2*g^2*exp(2*cc*(2*x4 + x5))*(x2 - x3)^2 + 160000*A^2*c1^2*cc^2*exp(cc*(2*x4 + 3*x5))*abs(g*(x1 - x3))*abs(g*(x2 - x3)) + 160000*A^2*c2^2*cc^2*g^2*exp(cc*(3*x4 + 2*x5))*(x2 - x3)^2 + 240000*A^2*c1^2*cc^2*exp(2*cc*(x4 + x5))*abs(g*(x1 - x3))*abs(g*(x2 - x3)) + 240000*A^2*c2^2*cc^2*g^2*exp(2*cc*(x4 + x5))*(x2 - x3)^2 + 40000*A^2*c1^2*cc^2*exp(2*cc*x4)*abs(g*(x1 - x3))*abs(g*(x2 - x3)) + 40000*A^2*c2^2*cc^2*g^2*exp(2*cc*x5)*(x2 - x3)^2)/(40000*A*cc^2*abs(g*(x2 - x3))*(4*c1^2*exp(cc*(2*x4 + 3*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(3*x4 + 2*x5))*abs(g*(x2 - x3)) + 6*c1^2*exp(2*cc*(x4 + x5))*abs(g*(x1 - x3)) + 6*c2^2*exp(2*cc*(x4 + x5))*abs(g*(x2 - x3)) + c1^2*exp(2*cc*x4)*abs(g*(x1 - x3)) + c2^2*exp(2*cc*x5)*abs(g*(x2 - x3)) + 4*c1^2*exp(cc*(2*x4 + x5))*abs(g*(x1 - x3)) + c1^2*exp(2*cc*(x4 + 2*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(x4 + 2*x5))*abs(g*(x2 - x3)) + c2^2*exp(2*cc*(2*x4 + x5))*abs(g*(x2 - x3)))) - (81*c2^2*g^2*exp(2*cc*x5)*(exp(cc*x4) + 1)^4*(exp(cc*x5) + 1)^2)/(40000*A*cc^2*abs(g*(x2 - x3))*(4*c1^2*exp(cc*(2*x4 + 3*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(3*x4 + 2*x5))*abs(g*(x2 - x3)) + 6*c1^2*exp(2*cc*(x4 + x5))*abs(g*(x1 - x3)) + 6*c2^2*exp(2*cc*(x4 + x5))*abs(g*(x2 - x3)) + c1^2*exp(2*cc*x4)*abs(g*(x1 - x3)) + c2^2*exp(2*cc*x5)*abs(g*(x2 - x3)) + 4*c1^2*exp(cc*(2*x4 + x5))*abs(g*(x1 - x3)) + c1^2*exp(2*cc*(x4 + 2*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(x4 + 2*x5))*abs(g*(x2 - x3)) + c2^2*exp(2*cc*(2*x4 + x5))*abs(g*(x2 - x3)))))*(x2r - x2 + (2^(1/2)*S*c2*exp(cc*x5)*(g*(x2 - x3))^(1/2))/(A*(exp(cc*x5) + 1)));
% u3 = (9*2^(1/2)*A*c1*exp(cc*x4)*(g*(x1 - x3))^(1/2)*(exp(cc*x4) + 1)^2*(exp(cc*x5) + 1)^4*(x3r - 2*x3dot - x2 + (((2^(1/2)*S*c1*g*exp(cc*x4)*(g*(x1 - x3))^(1/2))/(2*abs(g*(x1 - x3))*(exp(cc*x4) + 1)) + (2^(1/2)*S*c2*g*exp(cc*x5)*(g*(x2 - x3))^(1/2))/(2*abs(g*(x2 - x3))*(exp(cc*x5) + 1)))*((2^(1/2)*S*c1*exp(cc*x4)*abs(g*(x1 - x3)))/((g*(x1 - x3))^(1/2)*(exp(cc*x4) + 1)) + (2^(1/2)*S*c2*exp(cc*x5)*abs(g*(x2 - x3)))/((g*(x2 - x3))^(1/2)*(exp(cc*x5) + 1))))/A^2 + (S^2*c1^2*g*exp(2*cc*x4))/(A^2*(exp(cc*x4) + 1)^2) + (S^2*c2^2*g*exp(2*cc*x5))/(A^2*(exp(cc*x5) + 1)^2) + (2^(1/2)*S*c1*cc*cd*x4*exp(cc*x4)*abs(g*(x1 - x3)))/(A^2*(g*(x1 - x3))^(1/2)*(exp(cc*x4) + 1)^2) + (2^(1/2)*S*c2*cc*cd*x5*exp(cc*x5)*abs(g*(x2 - x3)))/(A^2*(g*(x2 - x3))^(1/2)*(exp(cc*x5) + 1)^2)))/(200*S*cc*(4*c1^2*exp(cc*(2*x4 + 3*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(3*x4 + 2*x5))*abs(g*(x2 - x3)) + 6*c1^2*exp(2*cc*(x4 + x5))*abs(g*(x1 - x3)) + 6*c2^2*exp(2*cc*(x4 + x5))*abs(g*(x2 - x3)) + c1^2*exp(2*cc*x4)*abs(g*(x1 - x3)) + c2^2*exp(2*cc*x5)*abs(g*(x2 - x3)) + 4*c1^2*exp(cc*(2*x4 + x5))*abs(g*(x1 - x3)) + c1^2*exp(2*cc*(x4 + 2*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(x4 + 2*x5))*abs(g*(x2 - x3)) + c2^2*exp(2*cc*(2*x4 + x5))*abs(g*(x2 - x3)))) - (9*c1^2*g^2*exp(2*cc*x4)*(x1 - x3)*(exp(cc*x4) + 1)*(exp(cc*x5) + 1)^4*(x1r - x1 + (2^(1/2)*S*c1*exp(cc*x4)*(g*(x1 - x3))^(1/2))/(A*(exp(cc*x4) + 1))))/(200*cc*abs(g*(x1 - x3))*(4*c1^2*exp(cc*(2*x4 + 3*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(3*x4 + 2*x5))*abs(g*(x2 - x3)) + 6*c1^2*exp(2*cc*(x4 + x5))*abs(g*(x1 - x3)) + 6*c2^2*exp(2*cc*(x4 + x5))*abs(g*(x2 - x3)) + c1^2*exp(2*cc*x4)*abs(g*(x1 - x3)) + c2^2*exp(2*cc*x5)*abs(g*(x2 - x3)) + 4*c1^2*exp(cc*(2*x4 + x5))*abs(g*(x1 - x3)) + c1^2*exp(2*cc*(x4 + 2*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(x4 + 2*x5))*abs(g*(x2 - x3)) + c2^2*exp(2*cc*(2*x4 + x5))*abs(g*(x2 - x3)))) - (9*c1*c2*g*exp(cc*(x4 + x5))*(g*(x1 - x3))^(1/2)*(g*(x2 - x3))^(1/2)*(exp(cc*x4) + 1)^2*(exp(cc*x5) + 1)^3*(x2r - x2 + (2^(1/2)*S*c2*exp(cc*x5)*(g*(x2 - x3))^(1/2))/(A*(exp(cc*x5) + 1))))/(200*cc*abs(g*(x2 - x3))*(4*c1^2*exp(cc*(2*x4 + 3*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(3*x4 + 2*x5))*abs(g*(x2 - x3)) + 6*c1^2*exp(2*cc*(x4 + x5))*abs(g*(x1 - x3)) + 6*c2^2*exp(2*cc*(x4 + x5))*abs(g*(x2 - x3)) + c1^2*exp(2*cc*x4)*abs(g*(x1 - x3)) + c2^2*exp(2*cc*x5)*abs(g*(x2 - x3)) + 4*c1^2*exp(cc*(2*x4 + x5))*abs(g*(x1 - x3)) + c1^2*exp(2*cc*(x4 + 2*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(x4 + 2*x5))*abs(g*(x2 - x3)) + c2^2*exp(2*cc*(2*x4 + x5))*abs(g*(x2 - x3))));
% u4 = (9*2^(1/2)*A*c2*exp(cc*x5)*(g*(x2 - x3))^(1/2)*(exp(cc*x4) + 1)^4*(exp(cc*x5) + 1)^2*(x3r - 2*x3dot - x2 + (((2^(1/2)*S*c1*g*exp(cc*x4)*(g*(x1 - x3))^(1/2))/(2*abs(g*(x1 - x3))*(exp(cc*x4) + 1)) + (2^(1/2)*S*c2*g*exp(cc*x5)*(g*(x2 - x3))^(1/2))/(2*abs(g*(x2 - x3))*(exp(cc*x5) + 1)))*((2^(1/2)*S*c1*exp(cc*x4)*abs(g*(x1 - x3)))/((g*(x1 - x3))^(1/2)*(exp(cc*x4) + 1)) + (2^(1/2)*S*c2*exp(cc*x5)*abs(g*(x2 - x3)))/((g*(x2 - x3))^(1/2)*(exp(cc*x5) + 1))))/A^2 + (S^2*c1^2*g*exp(2*cc*x4))/(A^2*(exp(cc*x4) + 1)^2) + (S^2*c2^2*g*exp(2*cc*x5))/(A^2*(exp(cc*x5) + 1)^2) + (2^(1/2)*S*c1*cc*cd*x4*exp(cc*x4)*abs(g*(x1 - x3)))/(A^2*(g*(x1 - x3))^(1/2)*(exp(cc*x4) + 1)^2) + (2^(1/2)*S*c2*cc*cd*x5*exp(cc*x5)*abs(g*(x2 - x3)))/(A^2*(g*(x2 - x3))^(1/2)*(exp(cc*x5) + 1)^2)))/(200*S*cc*(4*c1^2*exp(cc*(2*x4 + 3*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(3*x4 + 2*x5))*abs(g*(x2 - x3)) + 6*c1^2*exp(2*cc*(x4 + x5))*abs(g*(x1 - x3)) + 6*c2^2*exp(2*cc*(x4 + x5))*abs(g*(x2 - x3)) + c1^2*exp(2*cc*x4)*abs(g*(x1 - x3)) + c2^2*exp(2*cc*x5)*abs(g*(x2 - x3)) + 4*c1^2*exp(cc*(2*x4 + x5))*abs(g*(x1 - x3)) + c1^2*exp(2*cc*(x4 + 2*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(x4 + 2*x5))*abs(g*(x2 - x3)) + c2^2*exp(2*cc*(2*x4 + x5))*abs(g*(x2 - x3)))) - (9*c2^2*g^2*exp(2*cc*x5)*(x2 - x3)*(exp(cc*x4) + 1)^4*(exp(cc*x5) + 1)*(x2r - x2 + (2^(1/2)*S*c2*exp(cc*x5)*(g*(x2 - x3))^(1/2))/(A*(exp(cc*x5) + 1))))/(200*cc*abs(g*(x2 - x3))*(4*c1^2*exp(cc*(2*x4 + 3*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(3*x4 + 2*x5))*abs(g*(x2 - x3)) + 6*c1^2*exp(2*cc*(x4 + x5))*abs(g*(x1 - x3)) + 6*c2^2*exp(2*cc*(x4 + x5))*abs(g*(x2 - x3)) + c1^2*exp(2*cc*x4)*abs(g*(x1 - x3)) + c2^2*exp(2*cc*x5)*abs(g*(x2 - x3)) + 4*c1^2*exp(cc*(2*x4 + x5))*abs(g*(x1 - x3)) + c1^2*exp(2*cc*(x4 + 2*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(x4 + 2*x5))*abs(g*(x2 - x3)) + c2^2*exp(2*cc*(2*x4 + x5))*abs(g*(x2 - x3)))) - (9*c1*c2*g*exp(cc*(x4 + x5))*(g*(x1 - x3))^(1/2)*(g*(x2 - x3))^(1/2)*(exp(cc*x4) + 1)^3*(exp(cc*x5) + 1)^2*(x1r - x1 + (2^(1/2)*S*c1*exp(cc*x4)*(g*(x1 - x3))^(1/2))/(A*(exp(cc*x4) + 1))))/(200*cc*abs(g*(x1 - x3))*(4*c1^2*exp(cc*(2*x4 + 3*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(3*x4 + 2*x5))*abs(g*(x2 - x3)) + 6*c1^2*exp(2*cc*(x4 + x5))*abs(g*(x1 - x3)) + 6*c2^2*exp(2*cc*(x4 + x5))*abs(g*(x2 - x3)) + c1^2*exp(2*cc*x4)*abs(g*(x1 - x3)) + c2^2*exp(2*cc*x5)*abs(g*(x2 - x3)) + 4*c1^2*exp(cc*(2*x4 + x5))*abs(g*(x1 - x3)) + c1^2*exp(2*cc*(x4 + 2*x5))*abs(g*(x1 - x3)) + 4*c2^2*exp(cc*(x4 + 2*x5))*abs(g*(x2 - x3)) + c2^2*exp(2*cc*(2*x4 + x5))*abs(g*(x2 - x3))));
% 
% 

